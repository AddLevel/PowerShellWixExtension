<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:powershell="http://schemas.gardiner.net.au/PowerShellWixExtensionSchema">
  
	<Product Id="*" 
           Name="SampleSetup" 
           Language="1033" 
           Version="1.0.0.0" 
           Manufacturer="AddLevel" 
           UpgradeCode="fee1cf6a-5425-4c89-8c4d-0bb690ad9483">
    
		<Package InstallerVersion="200" 
             Compressed="yes" 
             InstallScope="perMachine"
             Platform="x64"/>

		<MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    
    <MediaTemplate EmbedCab="yes" />

    <Feature Id="ProductFeature" 
             Title="InstallSample" 
             Level="1"
             Absent="disallow"
             AllowAdvertise="no">
          	<ComponentGroupRef Id="SetupFiles" />
      
      		  <Feature Id="FEATURE_A" 
                     Title="Setup Feature A"
                     Description="Required setup files for various features."
                     Level="1">
		        </Feature>
    
    </Feature>

    <SetProperty Id="TESTPRO" Value="SETPROP" />
    

    <powershell:File Id="PSSetup" 
                     File="[#SetupPs1]" 
                     Arguments="&quot;First Argument&quot; 1" 
                     InstallAction="Install"/>
    
    <powershell:File Id="PSUninstall" 
                     File="[#UninstallPs1]" 
                     Arguments="&quot;First Argument&quot; 1" 
                     InstallAction="Uninstall" />
    
    <powershell:Script Id="Uninstall" Elevated="no">
      <![CDATA[

        # Note, for inline scripts square brackets need to be escaped so they don't get interpreted as MSI properties
        $wid=[\[]System.Security.Principal.WindowsIdentity[\]]::GetCurrent()
        $prp=new-object System.Security.Principal.WindowsPrincipal($wid)
        $adm=[\[]System.Security.Principal.WindowsBuiltInRole[\]]::Administrator
    
        Write-Host $wid.Name
        Write-Host $prp.IsInRole($adm)
        
        ]]>
    </powershell:Script>

    <!--UI>
      <TextStyle Id="WixUI_Font_Normal" FaceName="Tahoma" Size="8" />
      <TextStyle Id="WixUI_Font_Bigger" FaceName="Tahoma" Size="12" />
      <TextStyle Id="WixUI_Font_Title" FaceName="Tahoma" Size="9" Bold="yes" />

      <Property Id="DefaultUIFont" Value="WixUI_Font_Normal" />
      <Property Id="WixUI_Mode" Value="Minimal" />

      <DialogRef Id="ErrorDlg" />
      <DialogRef Id="FatalError" />
      <DialogRef Id="FilesInUse" />
      <DialogRef Id="ProgressDlg" />
      <DialogRef Id="UserExit" />

      <Publish Dialog="ExitDialog" Control="Finish" Event="EndDialog" Value="Return" Order="999">1</Publish>

      <Property Id="ARPNOMODIFY" Value="1" />
    </UI-->

    <UIRef Id="WixUI_Mondo" />

    <InstallExecuteSequence>
      
      <!-- These are the 'immediate' actions that prep the data for the 'deferred' actions-->
      <Custom Action="PowerShellScriptsImmediate" Before="PowerShellScriptsDeferred">Installed</Custom>
      <Custom Action="PowerShellScriptsElevatedImmediate" Before="PowerShellScriptsElevatedDeferred">Installed</Custom>

      <!-- 'Deferred' actions -->
      <Custom Action="PowerShellScriptsDeferred" Before="RemoveFiles">Installed</Custom>
      <Custom Action="PowerShellScriptsElevatedDeferred" Before="RemoveFiles">Installed</Custom>

    </InstallExecuteSequence>
    
	</Product>
  
	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
			<Directory Id="ProgramFiles64Folder">
				<Directory Id="INSTALLFOLDER" Name="SampleSetup">
          <Directory Id ="SETUP" Name="Setup" />
			  </Directory>
    	</Directory>
		</Directory>
	</Fragment>

	<Fragment> 
		<ComponentGroup Id="SetupFiles" Directory="SETUP">
      <Component Id="Install" Win64="yes">
        <File Id="SetupPs1" Source="scripts\setup.ps1" KeyPath="yes" Hidden="yes"/>
      </Component>
      <Component Id="Uninstall" Win64="yes">
        <File Id="UninstallPs1" Source="scripts\uninstall.ps1" KeyPath="yes" Hidden="yes"/>
      </Component>
		</ComponentGroup>
	</Fragment>

</Wix>
